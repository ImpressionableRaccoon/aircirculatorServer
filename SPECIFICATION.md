# Техническое задание

## Сервис для управления устройствами обеззараживания воздуха «Рециркуляторы»

### Общие требования

Cервис представляет собой HTTP API со следующими требованиями к бизнес-логике:

* аутентификация и авторизация пользователей;
* создание группы устройств (компании);
* создание рециркуляторов, которые принадлежат компаниям;
* для рециркулятора задается расписание, которое он получает и работает по нему;
* периодически рециркулятор передает свои состояния, сохраняем в базу данных и потом из них собираем журнал;
* у рециркулятора свой ресурс, из которого вычитаются записи журнала;
* устройство получает и обновляет прошивку с сервера;
* если закончилась лампа или рециркулятор выключился, то будет отправлено уведомление в телеграм.

### Абстрактная схема взаимодействия с системой

Ниже представлена абстрактная бизнес-логика взаимодействия пользователя с сервисом:

1. Пользователь регистрируется в сервисе «Рециркуляторы».
2. Пользователь создает группу устройств и добавляет туда устройства.
3. Физические устройства подключаются к сервису, обновляют прошивку и получают расписание.
4. Рециркуляторы каждые несколько секунд передают свое состояние.
5. Ведется учет оставшегося ресурса у рециркулятора.
6. Воркер, который собирает из состояний журнал, в какие периоды было включено устройство.
7. Воркер, который будет писать в телеграм, когда включается/выключается рециркулятор или закончился ресурс.

### Сводное HTTP API

Сервис «Рециркуляторы» должен предоставлять следующие HTTP-хендлеры:

* `POST /api/user/register` - регистрация пользователя;
* `POST /api/user/login` - аутентификация пользователя;
* `GET /api/user` - информация о текущем пользователе;
* `GET /api/company` - получить компании пользователя;
* `POST /api/company` - создать новую компанию;
* `GET /api/company/{id}` - информация о компании;
* `GET /api/company/{id}/devices` - устройства в компании;
* `POST /api/device` - создать устройство;
* `GET /api/device/{id}` - получить информацию об устройстве;
* `GET /api/device/{id}/schedule` - получить расписание устройства;
* `POST /api/device/{id}/schedule` - добавить расписание устройства;
* `DELETE /api/device/{id}/schedule/{schedule_id}` - удалить расписание устройства;
* `GET /api/device/{id}/journal` - получить журнал устройства;
* `GET /api/device/info` - информация об устройстве;
* `GET /api/device/firmware` - прошивка устройства;
* `GET /api/device/schedule` - расписание устройства;
* `POST /api/device/state` - состояния устройства.

[//]: # (* `POST /api/admin/firmware` - загрузить прошивку;)

#### **Регистрация пользователя**

Хендлер: `POST /api/user/register`

Регистрация производится по паре логин/пароль. Каждый логин должен быть уникальным.
После успешной регистрации должна происходить автоматическая аутентификация пользователя.

```
POST /api/user/register HTTP/1.1
Content-Type: application/json
...

{
    "login": "<login>",
    "password": "<password>"
}
```

Возможные коды ответа:

- `201` — пользователь успешно зарегистрирован и аутентифицирован;
- `400` — неверный формат запроса;
- `409` — логин уже занят;
- `500` — внутренняя ошибка сервера.

#### **Аутентификация пользователя**

Хендлер: `POST /api/user/login`

Аутентификация производится по паре логин/пароль.

```
POST /api/user/login HTTP/1.1
Content-Type: application/json
...

{
    "login": "<login>",
    "password": "<password>"
}
```

Возможные коды ответа:

- `200` — пользователь успешно аутентифицирован;
- `400` — неверный формат запроса;
- `401` — неверная пара логин/пароль;
- `500` — внутренняя ошибка сервера.

#### **Информация о пользователе**

Хендлер: `GET /api/user`

Хендлер доступен только авторизованному пользователю.
В ответе должна содержаться информация о текущем пользователе.

```
GET /api/user HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
        "id": "900e92e8-b8ba-41e2-9c6a-4bc38665de29",
        "login": "alex",
        "is_admin": false,
        "last_online" : "2023-01-01 12:30:00"
    }
    ```

- `401` — пользователь не авторизован;
- `500` — внутренняя ошибка сервера.

#### **Получить компании пользователя**

Хендлер: `GET /api/company`

Хендлер доступен только авторизованному пользователю.
В ответе должна содержаться информация о компаниях пользователя.
Администратор получает список всех компаний, а не только своих.

```
GET /api/company HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "company_id": "dab7338b-d711-4061-bb93-6dca70ae1e15",
            "name": "Поликлиника №123"
        },
        {
            "company_id": "4b690fd2-dbc2-44fb-b63c-99989a10601c",
            "name": "Больница №321"
        }
    ]
    ```

- `204` — компании не найдены;
- `401` — пользователь не авторизован;
- `500` — внутренняя ошибка сервера.

#### **Создать новую компанию**

Хендлер: `POST /api/company`

Пользователь должен быть авторизован.
Создаем компанию, принадлежащую текущему пользователю; название должно быть уникальным в пределах компаний пользователя.

```
POST /api/company HTTP/1.1
Content-Type: application/json
...

{
    "name": "Центральная больница",
    "time_offset": "03:00:00"
}
```

Возможные коды ответа:

- `201` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
        "id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
        "owner_id": "4370e4ae-8a4a-4241-a681-754fd86aab4a",
        "name": "Центральная больница",
        "time_offset": "03:00:00"
    }
    ```

- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `409` — компания с таким названием уже существует у пользователя;
- `500` — внутренняя ошибка сервера.

#### **Информация о компании**

Хендлер: `GET /api/company/{id}`

Пользователь должен быть авторизован.
Получаем информацию о компании по ID.

```
GET /api/company/{id} HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
        "id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
        "owner_id": "4370e4ae-8a4a-4241-a681-754fd86aab4a",
        "name": "Центральная больница",
        "time_offset": "03:00:00"
    }
    ```

- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — компания не принадлежит текущему пользователю;
- `404` — компания не найдена;
- `500` — внутренняя ошибка сервера.

#### **Устройства в компании**

Хендлер: `GET /api/company/{id}/devices`

Пользователь должен быть авторизован.
Получаем информацию об устройствах в компании.

```
GET /api/company/{id}/devices HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
            "company_id" : "adefc355-1459-4a21-abbb-08a36728f979",
            "name" : "Коридор",
            "resource" : 300000,
            "minutes_remaining" : 244444,
            "last_online" : "2023-02-02 22:35:03"
        },
        {
            "id": "921f79d3-26c5-4d50-9ef7-10f228ca9e17",
            "company_id" : "adefc355-1459-4a21-abbb-08a36728f979",
            "name" : "Кабинет №1",
            "resource" : 300000,
            "minutes_remaining" : 255555,
            "last_online" : "2023-02-02 22:33:54"
        },
        {
            "id": "bc3b0a47-0bd4-4907-90d0-47370c2fbcd7",
            "company_id" : "adefc355-1459-4a21-abbb-08a36728f979",
            "name" : "Кабинет №2",
            "resource" : 300000,
            "minutes_remaining" : 234567,
            "last_online" : "2023-02-02 22:34:34"
        }
    ]
    ```

- `204` — устройства не найдены;
- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — компания не принадлежит текущему пользователю;
- `404` — компания не найдена;
- `500` — внутренняя ошибка сервера.

#### **Создать новое устройство**

Хендлер: `POST /api/device`

Пользователь должен быть авторизован.
Создаем новое устройство, название должно быть уникальным в пределах компании.

```
POST /api/company HTTP/1.1
Content-Type: application/json
...

{
    "company_id": "adefc355-1459-4a21-abbb-08a36728f979",
    "name": "Коридор",
    "resource": 300000
}
```

Возможные коды ответа:

- `201` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
        "id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
        "token": "c32978bffb1db81f3ab6845a3e840f88",
        "company_id" : "adefc355-1459-4a21-abbb-08a36728f979",
        "name" : "Коридор",
        "resource" : 300000
    }
    ```

- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — компания не найдена или не принадлежит пользователю;
- `409` — устройство с таким названием уже существует в компании;
- `500` — внутренняя ошибка сервера.

#### **Информация об устройстве**

Хендлер: `GET /api/device/{id}`

Пользователь должен быть авторизован.
Получаем информацию по ID устройства.

```
GET /api/device/{id} HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...

    {
        "id": "bc3b0a47-0bd4-4907-90d0-47370c2fbcd7",
        "company_id" : "adefc355-1459-4a21-abbb-08a36728f979",
        "name" : "Кабинет №2",
        "resource" : 300000,
        "minutes_remaining" : 234567,
        "last_online" : "2023-02-02 22:34:34"
    }
    ```

- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — устройство не принадлежит текущему пользователю;
- `404` — устройство не найдено;
- `500` — внутренняя ошибка сервера.

#### **Расписание устройства**

Хендлер: `GET /api/device/{id}/schedule`

Пользователь должен быть авторизован.
Получаем расписание по ID устройства.

```
GET /api/device/{id}/schedule HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "id": "f5f3f96d-bc4c-4897-9789-bc82ffd9fe67",
            "device_id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
            "week_day": 0,
            "time_start": 600,
            "time_stop": 1200
        },
        {
            "id": "b7998041-f728-48f3-8ee4-3b8bae483aa3",
            "device_id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
            "week_day": 1,
            "time_start": 620,
            "time_stop": 1220
        }
    ]
    ```

- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — устройство не принадлежит текущему пользователю;
- `404` — устройство не найдено;
- `500` — внутренняя ошибка сервера.

#### **Добавить расписание устройства**

Хендлер: `POST /api/device/{id}/schedule`

Пользователь должен быть авторизован.
Добавляем записи о расписании для устройства.
Если какая-то запись уже существует, то будет возвращена уже существующая (дубликаты не создаются).

```
POST /api/device/{id}/schedule HTTP/1.1
Content-Type: application/json
...

[
    {
        "week_day": 0,
        "time_start": 600,
        "time_stop": 1200
    },
    {
        "week_day": 1,
        "time_start": 600,
        "time_stop": 1200
    }
]
```

Возможные коды ответа:

- `201` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "id": "f5f3f96d-bc4c-4897-9789-bc82ffd9fe67",
            "device_id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
            "week_day": 0,
            "time_start": 600,
            "time_stop": 1200
        },
        {
            "id": "b7998041-f728-48f3-8ee4-3b8bae483aa3",
            "device_id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
            "week_day": 1,
            "time_start": 620,
            "time_stop": 1220
        }
    ]
    ```

- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — компания не принадлежит пользователю;
- `404` — компания или устройство не найдено;
- `500` — внутренняя ошибка сервера.
- 
#### **Удалить расписание устройства**

Хендлер: `DELETE /api/device/{id}/schedule/{schedule_id}`

Пользователь должен быть авторизован.
Удаляем записать о расписании у устройства.

```
DELETE /api/device/{id}/schedule/{schedule_id} HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса;
- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — компания не принадлежит пользователю;
- `404` — компания или устройство не найдено;
- `500` — внутренняя ошибка сервера.

#### **Журнал устройства**

Хендлер: `GET /api/device/{id}/journal`

Пользователь должен быть авторизован.
Получаем журнал по ID устройства.

```
GET /api/device/{id}/journal HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "id": "32f53791-62a2-40ce-9d78-fd8da3e63359",
            "device_id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
            "timestamp_start": "2023-02-02 09:00:00",
            "timestamp_end": "2023-02-02 18:00:00"
        },
        {
            "id": "32f53791-62a2-40ce-9d78-fd8da3e63359",
            "device_id": "d5c9b10e-2e83-4ea3-af20-fcb61d584a88",
            "timestamp_start": "2023-02-03 09:00:00",
            "timestamp_end": "2023-02-03 18:00:00"
        }
    ]
    ```

- `400` — неверный формат запроса;
- `401` — пользователь не авторизован;
- `403` — устройство не принадлежит текущему пользователю;
- `404` — устройство не найдено;
- `500` — внутренняя ошибка сервера.

#### **Информация об устройстве**

Хендлер: `GET /api/device/info`

Устройство должно быть авторизовано через Basic Auth.
Получаем информацию об устройстве (проверяем авторизацию).

```
GET /api/device/info HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
        "id": "bc3b0a47-0bd4-4907-90d0-47370c2fbcd7",
        "company_id" : "adefc355-1459-4a21-abbb-08a36728f979",
        "name" : "Кабинет №2",
        "resource" : 300000,
        "minutes_remaining" : 234567,
        "last_online" : "2023-02-02 22:34:34"
    }
    ```

- `400` — неверный формат запроса;
- `401` — устройство не авторизовано;
- `500` — внутренняя ошибка сервера.

#### **Прошивка устройства**

Хендлер: `GET /api/device/firmware`

Не проверяем авторизацию устройства.

```
GET /api/device/firmware HTTP/1.1
Content-Length: 0
x-ESP32-sketch-md5: <md5-hash>
x-ESP32-sketch-sha256: <sha256-hash>
```

Возможные коды ответа:

- `200` — успешная обработка запроса, отдаем прошивку;
- `304` — прошивка на устройстве актуальная;
- `400` — неверный формат запроса;
- `500` — внутренняя ошибка сервера.

#### **Расписание устройства**

Хендлер: `GET /api/device/schedule`

Устройство должно быть авторизовано через Basic Auth.
Получаем расписание устройства.

```
GET /api/device/schedule HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    SHA256-hash: <sha256-hash>
    ...
    
    [
        {
            "week_day": 0,
            "time_start": 600,
            "time_stop": 1200
        },
        {
            "week_day": 1,
            "time_start": 620,
            "time_stop": 1220
        }
    ]
    ```

- `400` — неверный формат запроса;
- `401` — устройство не авторизовано;
- `500` — внутренняя ошибка сервера.

#### **Передача состояний устройства**

Хендлер: `POST /api/device/state`

Устройство должно быть авторизовано через Basic Auth.
Передаем состояния устройства.

```
POST /api/device/state HTTP/1.1
Content-Type: application/json
...

[
    {
        "timestamp": "2023-02-02 22:34:34",
        "mode": "auto",
        "enabled": 0
    },
    {
        "timestamp": "2023-02-02 23:00:00",
        "mode": "auto",
        "enabled": 1
    },
    {
        "timestamp": "2023-02-03 12:00:00",
        "mode": "manual",
        "enabled": 1
    }
]
```

Возможные коды ответа:

- `200` — успешная обработка запроса;
- `400` — неверный формат запроса;
- `401` — устройство не авторизовано;
- `500` — внутренняя ошибка сервера.
